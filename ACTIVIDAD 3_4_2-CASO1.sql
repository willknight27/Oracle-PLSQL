--TRIGGER
CREATE OR REPLACE TRIGGER TGR_COMPRA_TARJETA_CUPO
AFTER INSERT ON TRANSACCION_TARJETA_CLIENTE
FOR EACH ROW

DECLARE
V_CUPO NUMBER(10);
BEGIN

    
    IF :NEW.COD_TPTRAN_TARJETA = 101 OR :NEW.COD_TPTRAN_TARJETA = 102 THEN
    
        SELECT
        CUPO_DISP_COMPRA
        INTO V_CUPO
        FROM TARJETA_CLIENTE
        WHERE NRO_TARJETA = :NEW.NRO_TARJETA;
    
        UPDATE TARJETA_CLIENTE
        SET CUPO_DISP_COMPRA = V_CUPO - :NEW.MONTO_TOTAL_TRANSACCION
        WHERE NRO_TARJETA = :NEW.NRO_TARJETA;
    ELSIF :NEW.COD_TPTRAN_TARJETA = 103 THEN
        
        SELECT
        CUPO_DISP_SP_AVANCE
        INTO V_CUPO
        FROM TARJETA_CLIENTE
        WHERE NRO_TARJETA = :NEW.NRO_TARJETA;
        
        UPDATE TARJETA_CLIENTE
        SET CUPO_DISP_SP_AVANCE = V_CUPO - :NEW.MONTO_TOTAL_TRANSACCION
        WHERE NRO_TARJETA = :NEW.NRO_TARJETA;
        
    END IF;       

END TGR_COMPRA_TARJETA_CUPO;
/
--INSERT
INSERT INTO TRANSACCION_TARJETA_CLIENTE VALUES(29320393064,1001,to_date('04/05/'||TO_CHAR(SYSDATE,'YY')),800000,24,845000,101);
INSERT INTO TRANSACCION_TARJETA_CLIENTE VALUES(29320393064,1002,to_date('25/05/'||TO_CHAR(SYSDATE,'YY')),86500,6,90325,101);
INSERT INTO TRANSACCION_TARJETA_CLIENTE VALUES(29320393064,1003,to_date('25/05/'||TO_CHAR(SYSDATE,'YY')),485900,12,544490,103);
INSERT INTO TRANSACCION_TARJETA_CLIENTE VALUES(28418181488,1002,to_date('15/05/'||TO_CHAR(SYSDATE,'YY')),200000,10,215000,102);
/

SELECT  * FROM TRANSACCION_TARJETA_CLIENTE;
/
SELECT * FROM TARJETA_CLIENTE WHERE NRO_TARJETA = 28418181488